let jsonData=null,parsedData=[],allColumns=[],selectedColumns=[],filters=[],pgliteDB=null,sortConfig={column:null,direction:"asc"},displayMode="grouped",isComplexStructure=!1,hierarchicalData=null,tableMetadata=[];const defaultJSON={users:[{id:1,name:"Alice Johnson",email:"alice@example.com",department:"Engineering",salary:95e3,joinDate:"2021-03-15"},{id:2,name:"Bob Smith",email:"bob@example.com",department:"Marketing",salary:75e3,joinDate:"2021-06-20"},{id:3,name:"Carol White",email:"carol@example.com",department:"Engineering",salary:98e3,joinDate:"2020-01-10"},{id:4,name:"David Brown",email:"david@example.com",department:"Sales",salary:85e3,joinDate:"2022-02-14"},{id:5,name:"Eve Davis",email:"eve@example.com",department:"Engineering",salary:92e3,joinDate:"2021-11-05"}]};function setupEventListeners(){document.getElementById("fileInput").addEventListener("change",e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{document.getElementById("jsonInput").value=e.target.result},e.readAsText(t)}});const e=document.getElementById("sqlQuery");e&&(e.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),executeSQLQuery())}),e.addEventListener("input",function(){this.style.height="32px",this.style.height=Math.min(this.scrollHeight,200)+"px"}));const t=document.getElementById("jsonpathQuery");t&&(t.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),executeJSONPathQuery())}),t.addEventListener("input",function(){this.style.height="32px",this.style.height=Math.min(this.scrollHeight,200)+"px"}))}function loadDefaultJSON(){document.getElementById("jsonInput").value=JSON.stringify(defaultJSON,null,2),setTimeout(()=>{parseJSON()},100)}function toggleTopSection(){const e=document.getElementById("topSection"),t=document.getElementById("topSectionToggle");e.classList.toggle("collapsed"),e.classList.contains("collapsed")?t.textContent="Show Section":t.textContent="Hide Section"}function toggleOutputSection(){const e=document.getElementById("outputPanel"),t=document.getElementById("outputSectionToggle");e.classList.toggle("collapsed"),e.classList.contains("collapsed")?t.textContent="Show Section":t.textContent="Hide Section"}function toggleQuerySection(){const e=document.getElementById("queryPanel"),t=document.getElementById("querySectionToggle");e.classList.toggle("collapsed"),e.classList.contains("collapsed")?t.textContent="Show Section":t.textContent="Hide Section"}function showStatus(e,t="success",n=!1){const o=document.getElementById("detailsStatusMessage");o.textContent=e,o.className=`status-message show ${t}`,"error"===t||n||setTimeout(()=>{o.classList.remove("show")},3e3)}function parseJSON(){showLoader(),setTimeout(()=>{try{const e=document.getElementById("jsonInput").value.trim();if(!e)return hideLoader(),void showStatus("Please paste or upload JSON/XML/CSV data","error");if(e.startsWith("<?xml")||e.startsWith("<"))return void parseXML(e);if(!e.startsWith("{")&&!e.startsWith("[")&&(e.includes(",")||e.includes("\t")))return void parseCSV(e);jsonData=JSON.parse(e),isComplexStructure=detectComplexStructure(jsonData);const t=document.getElementById("displayModeSelector");isComplexStructure?t.classList.remove("hide"):t.classList.add("hide"),filters=[],normalizeData(),detectStructure(),buildColumns(),renderFilters(),toggleApplyButton(),buildTable(),initializePGLite(),hideLoader(),showStatus("JSON parsed successfully! "+parsedData.length+" records found.","success")}catch(e){hideLoader(),showStatus("Invalid JSON: "+e.message,"error")}},50)}function parseXML(e){try{const t=(new DOMParser).parseFromString(e,"text/xml"),n=t.getElementsByTagName("parsererror");if(n.length>0)throw hideLoader(),new Error("XML parsing error: "+n[0].textContent);jsonData=xmlToJson(t),document.getElementById("jsonInput").value=JSON.stringify(jsonData,null,2),filters=[],normalizeData(),detectStructure(),buildColumns(),renderFilters(),toggleApplyButton(),buildTable(),initializePGLite(),hideLoader(),showStatus("XML converted and parsed successfully! "+parsedData.length+" records found.","success")}catch(e){hideLoader(),showStatus("Invalid XML: "+e.message,"error")}}function xmlToJson(e){let t={};if(1===e.nodeType){if(e.attributes.length>0)for(let n=0;n<e.attributes.length;n++){const o=e.attributes.item(n);t[o.nodeName]=o.nodeValue}}else 3===e.nodeType&&(t=e.nodeValue.trim());if(e.hasChildNodes())for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes.item(n),a=o.nodeName;if(3===o.nodeType){const e=o.nodeValue.trim();if(e){if(!(Object.keys(t).length>0))return e;t.value=e}continue}if(void 0===t[a]){const e=xmlToJson(o);t[a]=e}else Array.isArray(t[a])||(t[a]=[t[a]]),t[a].push(xmlToJson(o))}return t}function parseCSV(e){try{const t=e.split("\n").filter(e=>e.trim());if(0===t.length)throw hideLoader(),new Error("CSV data is empty");const n=t[0];let o=",";n.includes("\t")?o="\t":n.includes(";")&&n.split(";").length>n.split(",").length&&(o=";");const a=parseCSVRow(t[0],o),r=[];for(let e=1;e<t.length;e++){const n=parseCSVRow(t[e],o);if(0===n.length||1===n.length&&""===n[0])continue;const l={};a.forEach((e,t)=>{let o=n[t]||"";if(""!==o&&!isNaN(o)&&""!==o.trim()){const e=parseFloat(o);isNaN(e)||(o=e)}l[e]=o}),r.push(l)}jsonData={data:r},document.getElementById("jsonInput").value=JSON.stringify(jsonData,null,2),filters=[],normalizeData(),detectStructure(),buildColumns(),renderFilters(),toggleApplyButton(),buildTable(),initializePGLite(),hideLoader(),showStatus("CSV converted and parsed successfully! "+parsedData.length+" records found.","success")}catch(e){hideLoader(),showStatus("Invalid CSV: "+e.message,"error")}}function parseCSVRow(e,t){const n=[];let o="",a=!1;for(let r=0;r<e.length;r++){const l=e[r],s=e[r+1];'"'===l?a&&'"'===s?(o+='"',r++):a=!a:l!==t||a?o+=l:(n.push(o.trim()),o="")}return n.push(o.trim()),n}function normalizeData(){if(containsArrays(jsonData))if("grouped"===displayMode){const e=analyzeStructure(jsonData);e.hasMultipleNestedArrays?(hierarchicalData=buildHierarchicalData(jsonData,e),parsedData=hierarchicalData.parent.data):(hierarchicalData=null,parsedData=normalizeDataGrouped(jsonData))}else{hierarchicalData=null;const e=pathsToCSV(flattenToLeafPaths(jsonData));parsedData=csvToRows(e)}else{hierarchicalData=null;const e=pathsToCSV(flattenToLeafPaths(jsonData));parsedData=csvToRows(e)}}function analyzeStructure(e,t="",n=0){const o={hasMultipleNestedArrays:!1,nestedArrays:[],rootArray:null};let a=e;if("object"==typeof e&&null!==e&&!Array.isArray(e)&&""===t){const t=Object.keys(e);if(1===t.length){const n=e[t[0]];(Array.isArray(n)||"object"==typeof n&&null!==n&&containsArrays(n))&&(a=n)}}if(Array.isArray(a)){if(o.rootArray=t||"root",a.length>0&&"object"==typeof a[0]&&null!==a[0]){const e=[];for(const[t,n]of Object.entries(a[0]))if(Array.isArray(n))e.push(t);else if("object"==typeof n&&null!==n){const o=Object.keys(n);(1===o.length&&Array.isArray(n[o[0]])||Object.values(n).some(e=>Array.isArray(e)))&&e.push(t)}e.length>1&&(o.hasMultipleNestedArrays=!0);for(const[e,r]of Object.entries(a[0]))if("object"==typeof r&&null!==r){const a=analyzeStructure(r,e,n+1);o.nestedArrays.push(...a.nestedArrays),Array.isArray(r)&&o.nestedArrays.push({path:e,parentPath:t||"root",name:e,depth:n+1})}}}else if("object"==typeof a&&null!==a){Object.entries(a).filter(([e,t])=>Array.isArray(t)).length>1&&(o.hasMultipleNestedArrays=!0);for(const[e,r]of Object.entries(a))if("object"==typeof r&&null!==r){const a=analyzeStructure(r,t?`${t}.${e}`:e,n+1);a.hasMultipleNestedArrays&&(o.hasMultipleNestedArrays=!0),o.nestedArrays.push(...a.nestedArrays),a.rootArray&&o.nestedArrays.push({path:t?`${t}.${e}`:e,parentPath:t||"root",name:e,depth:n+1})}}return o}function buildHierarchicalData(e,t){const n={parent:{name:"parent",data:[],tableName:"parent"},children:[]};let o=e;if("object"==typeof e&&null!==e&&!Array.isArray(e)){const t=Object.keys(e);if(1===t.length){const n=e[t[0]];(Array.isArray(n)||"object"==typeof n&&null!==n&&containsArrays(n))&&(o=n)}}let a=[],r="";if(Array.isArray(o))a=o,r="items";else if("object"==typeof o&&null!==o)for(const[e,t]of Object.entries(o)){if(Array.isArray(t)){a=t,r=e;break}if("object"==typeof t&&null!==t){for(const[e,n]of Object.entries(t))if(Array.isArray(n)){a=n,r=e;break}if(a.length>0)break}}return 0===a.length?(n.parent.data=[o],n):(a.forEach((e,t)=>{if("object"!=typeof e||null===e)return;const o={_id:t},a={};for(const[t,n]of Object.entries(e))if(Array.isArray(n))a[t]=n;else if("object"==typeof n&&null!==n){const e=Object.keys(n);if(1===e.length&&Array.isArray(n[e[0]]))a[e[0]]=n[e[0]];else{let e=!1;for(const[t,o]of Object.entries(n))Array.isArray(o)&&(a[t]=o,e=!0);e||flattenObjectProperties(n,t,o,"")}}else o[t]=n;n.parent.data.push(o);for(const[e,o]of Object.entries(a)){let a=n.children.find(t=>t.name===e);a||(a={name:e,tableName:toSnakeCase(e),data:[],parentKey:"_parent_id"},n.children.push(a)),o.forEach((e,n)=>{const o={_id:a.data.length,_parent_id:t};if("object"!=typeof e||null===e||Array.isArray(e))o.value=e;else for(const[t,n]of Object.entries(e))Array.isArray(n)||"object"==typeof n&&null!==n||(o[t]=n);a.data.push(o)})}}),n.parent.tableName=toSnakeCase(r)||"parent",n)}function toSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"").replace(/\s+/g,"_")}function normalizeDataGrouped(e,t="",n={}){const o=[];let a=e;if("object"==typeof e&&null!==e&&!Array.isArray(e)&&""===t){const t=Object.keys(e);if(1===t.length){const n=e[t[0]];if(Array.isArray(n))a=n;else if("object"==typeof n&&null!==n){containsArrays(n)&&(a=n)}}}if(Array.isArray(a))a.forEach((e,a)=>{const r=`${t}_Index`,l={...n,[r]:a};if("object"!=typeof e||null===e||Array.isArray(e))if(Array.isArray(e)){const n=normalizeDataGrouped(e,t,l);o.push(...n)}else l[`${t}_Value`]=e,o.push(l);else{const n={...l};flattenObjectProperties(e,"",n,t);const a=findAndProcessNestedArrays(e,t,n);a.length>0?o.push(...a):o.push(n)}});else if("object"==typeof a&&null!==a){if(Object.values(a).some(e=>Array.isArray(e)||"object"==typeof e&&null!==e)){for(const[e,t]of Object.entries(a))if(Array.isArray(t)){const a=normalizeDataGrouped(t,e,n);o.push(...a)}else if("object"==typeof t&&null!==t){const a=normalizeDataGrouped(t,e,n);o.push(...a)}}else{const e={};flattenObjectProperties(a,"",e,""),o.push(e)}}return o.length>0?o:[{Value:a}]}function flattenObjectProperties(e,t,n,o){for(const[a,r]of Object.entries(e)){const e=t?`${t}.${a}`:o?`${removeArraySuffix(o)}.${a}`:a;"object"!=typeof r||null===r||Array.isArray(r)?Array.isArray(r)||(n[e]=r):flattenObjectProperties(r,e,n,o)}}function findAndProcessNestedArrays(e,t,n){const o=[];for(const[a,r]of Object.entries(e))if(Array.isArray(r)){const e=normalizeDataGrouped(r,a,n);o.push(...e)}else if("object"==typeof r&&null!==r){const e=findAndProcessNestedArrays(r,t,n);e.length>0&&o.push(...e)}return o}function removeArraySuffix(e){return e.endsWith("s")&&e.length>2?e.slice(0,-1):e}function containsArrays(e){if(Array.isArray(e))return!0;if("object"!=typeof e||null===e)return!1;for(const t of Object.values(e)){if(Array.isArray(t))return!0;if("object"==typeof t&&null!==t&&containsArrays(t))return!0}return!1}function flattenToLeafPaths(e,t=""){let n={};if(null==e)return{[t]:e};if("object"!=typeof e)return{[t]:e};if(Array.isArray(e))return e.forEach((e,o)=>{const a=t?`${t}[${o}]`:`[${o}]`;Object.assign(n,flattenToLeafPaths(e,a))}),n;const o=Object.keys(e);let a=!1;return o.forEach(o=>{const r=e[o],l=t?`${t}.${o}`:o;null==r?n[l]=r:"object"==typeof r?(a=!0,Object.assign(n,flattenToLeafPaths(r,l))):n[l]=r}),n}function pathsToCSV(e){const t=[];for(let n in e){const o=e[n],a=n.split(/\.|\[/).map(e=>e.endsWith("]")?"["+e.slice(0,-1)+"]":e).filter(e=>""!==e),r={};a.forEach((e,t)=>{t<a.length-1?r[`path_${t}`]=e:r.metric=e}),r.value=o,t.push(r)}return t}function csvToRows(e){if(0===e.length)return[];let t=0;e.forEach(e=>{let n=0;for(;void 0!==e[`path_${n}`];)n++,t=Math.max(t,n)});const n=new Set;e.forEach(e=>{void 0!==e.path_0&&n.add(e.path_0)});const o=1===n.size,a={};e.forEach(e=>{const n=[];for(let o=0;o<t;o++)void 0!==e[`path_${o}`]&&n.push(e[`path_${o}`]);const r=n.join("|");let l;if(a[r]||(a[r]={},n.forEach((e,t)=>{a[r][`path_${t}`]=e})),o){const n=[];for(let o=1;o<t;o++){const t=e[`path_${o}`];void 0===t||t.match(/^\[\d+\]$/)||n.push(t)}n.push(e.metric),l=n.join(".")}else l=e.metric;a[r][l]=e.value});const r=Object.values(a);return r.forEach(e=>{if(o)for(let n=0;n<t;n++)delete e[`path_${n}`];else for(let n=0;n<t;n++)void 0!==e[`path_${n}`]&&(e[`Key${n+1}`]=e[`path_${n}`],delete e[`path_${n}`])}),r}function detectStructure(){if(0===parsedData.length)return;const e=document.getElementById("detailsEmpty");e&&e.classList.add("hide")}function buildColumns(){if(allColumns=[],0===parsedData.length)return;const e=new Set;parsedData.forEach(t=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach(t=>e.add(t))}),allColumns=Array.from(e).sort((e,t)=>{const n=e.match(/^Key(\d+)$/),o=t.match(/^Key(\d+)$/),a=e.endsWith("_Index"),r=t.endsWith("_Index");return a&&!r?-1:!a&&r?1:n&&o?parseInt(n[1])-parseInt(o[1]):n?-1:o?1:e.localeCompare(t)}),selectedColumns=[...allColumns],renderColumnList(),document.getElementById("columnSelector").classList.remove("hide"),document.getElementById("filterControls").classList.remove("hide")}function renderColumnList(){const e=document.getElementById("columnList");e.innerHTML="",allColumns.forEach((t,n)=>{const o=document.createElement("div");o.className="column-item",o.draggable=!0,o.dataset.columnIndex=n,o.dataset.columnName=t,o.innerHTML=`\n            <span class="drag-handle">⋮⋮</span>\n            <input type="checkbox" id="col_${t}" checked onchange="updateSelectedColumns()">\n            <label for="col_${t}">${escapeHtml(t)}</label>\n        `,o.addEventListener("dragstart",handleDragStart),o.addEventListener("dragover",handleDragOver),o.addEventListener("drop",handleDrop),o.addEventListener("dragend",handleDragEnd),o.addEventListener("dragenter",handleDragEnter),o.addEventListener("dragleave",handleDragLeave),e.appendChild(o)})}document.addEventListener("DOMContentLoaded",()=>{setupEventListeners(),loadDefaultJSON()});let draggedElement=null;function handleDragStart(e){draggedElement=this,this.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function handleDragEnter(e){this!==draggedElement&&this.classList.add("drag-over")}function handleDragLeave(e){this.classList.remove("drag-over")}function handleDrop(e){if(e.preventDefault(),this!==draggedElement){const e=parseInt(draggedElement.dataset.columnIndex),t=parseInt(this.dataset.columnIndex);[allColumns[e],allColumns[t]]=[allColumns[t],allColumns[e]],renderColumnList(),updateSelectedColumns()}}function handleDragEnd(e){this.classList.remove("dragging"),document.querySelectorAll(".column-item").forEach(e=>{e.classList.remove("drag-over")}),draggedElement=null}function updateSelectedColumns(){selectedColumns=[],allColumns.forEach(e=>{const t=document.getElementById(`col_${e}`);t&&t.checked&&selectedColumns.push(e)}),buildTable()}function selectAllColumns(){allColumns.forEach(e=>{const t=document.getElementById(`col_${e}`);t&&(t.checked=!0)}),updateSelectedColumns()}function deselectAllColumns(){allColumns.forEach(e=>{const t=document.getElementById(`col_${e}`);t&&(t.checked=!1)}),updateSelectedColumns()}function buildTable(){document.getElementById("tableHead"),document.getElementById("tableBody");const e=document.getElementById("tableContainer"),t=document.getElementById("noData");let n=getFilteredData();if(0===selectedColumns.length||0===n.length)return e.classList.add("hide"),t.classList.remove("hide"),void(document.getElementById("statsContainer").style.display="none");hierarchicalData&&hierarchicalData.children.length>0?buildHierarchicalTable(n):buildSimpleTable(n),e.classList.remove("hide"),t.classList.add("hide"),updateStats(n),document.getElementById("statsContainer").style.display="grid"}function buildSimpleTable(e){const t=document.getElementById("tableHead"),n=document.getElementById("tableBody");t.innerHTML="",selectedColumns.forEach(e=>{const n=document.createElement("th");n.innerHTML=`${escapeHtml(e)} <span class="sort-indicator">${getSortIndicator(e)}</span>`,n.onclick=()=>sortTable(e),t.appendChild(n)}),n.innerHTML="",e.forEach(e=>{const t=document.createElement("tr");selectedColumns.forEach(n=>{const o=document.createElement("td"),a=e[n];o.textContent=formatCellValue(a),t.appendChild(o)}),n.appendChild(t)})}function buildHierarchicalTable(e){const t=document.getElementById("tableHead"),n=document.getElementById("tableBody");t.innerHTML="";const o=document.createElement("th");o.style.width="40px",o.textContent="",t.appendChild(o),selectedColumns.forEach(e=>{const n=document.createElement("th");n.innerHTML=`${escapeHtml(e)} <span class="sort-indicator">${getSortIndicator(e)}</span>`,n.onclick=()=>sortTable(e),t.appendChild(n)}),n.innerHTML="",e.forEach((e,t)=>{const o=document.createElement("tr");o.dataset.rowId=void 0!==e._id?e._id:t;const a=document.createElement("td");a.style.textAlign="center",a.style.cursor="pointer",a.innerHTML='<span class="expand-icon">▶</span>',a.onclick=()=>toggleChildTables(o,void 0!==e._id?e._id:t),o.appendChild(a),selectedColumns.forEach(t=>{const n=document.createElement("td"),a=e[t];n.textContent=formatCellValue(a),o.appendChild(n)}),n.appendChild(o)})}function toggleChildTables(e,t){const n=e.querySelector(".expand-icon"),o=e.nextElementSibling;if(o&&o.classList.contains("child-tables-row"))o.remove(),n.textContent="▶";else{n.textContent="▼";const o=document.createElement("tr");o.classList.add("child-tables-row");const a=document.createElement("td");a.colSpan=selectedColumns.length+1,a.style.padding="0",a.style.background="var(--bg-secondary)";const r=document.createElement("div");r.style.padding="12px",r.style.display="grid",r.style.gap="16px",hierarchicalData.children.forEach(e=>{const n=e.data.filter(e=>e._parent_id===t);if(0===n.length)return;const o=document.createElement("div");o.style.border="1px solid var(--border-color)",o.style.borderRadius="4px",o.style.overflow="hidden";const a=document.createElement("div");a.style.padding="8px 12px",a.style.background="var(--bg-tertiary)",a.style.fontWeight="600",a.style.fontSize="12px",a.style.borderBottom="1px solid var(--border-color)",a.textContent=`${e.name} (${n.length} rows)`;const l=document.createElement("table");l.style.width="100%",l.style.fontSize="11px";const s=Object.keys(n[0]).filter(e=>!e.startsWith("_")),i=document.createElement("thead"),c=document.createElement("tr");s.forEach(e=>{const t=document.createElement("th");t.textContent=e,t.style.padding="6px 8px",t.style.background="var(--bg-primary)",t.style.borderBottom="1px solid var(--border-color)",t.style.textAlign="left",c.appendChild(t)}),i.appendChild(c),l.appendChild(i);const d=document.createElement("tbody");n.forEach(e=>{const t=document.createElement("tr");s.forEach(n=>{const o=document.createElement("td");o.textContent=formatCellValue(e[n]),o.style.padding="6px 8px",o.style.borderBottom="1px solid var(--border-color)",t.appendChild(o)}),d.appendChild(t)}),l.appendChild(d),o.appendChild(a),o.appendChild(l),r.appendChild(o)}),a.appendChild(r),o.appendChild(a),e.parentNode.insertBefore(o,e.nextSibling)}}function getFilteredData(){let e=[...parsedData];filters.length>0&&(e=e.filter(e=>filters.every(t=>{if(!t.column||!t.operator)return!0;if(["equals","notequals","contains","starts","ends","regex","gt","lt","gte","lte"].includes(t.operator)&&""===t.value)return!0;const n=e[t.column],o=t.value,a=e=>{switch(t.operator){case"equals":return String(e).toLowerCase()===o.toLowerCase();case"notequals":return String(e).toLowerCase()!==o.toLowerCase();case"contains":return String(e).toLowerCase().includes(o.toLowerCase());case"starts":return String(e).toLowerCase().startsWith(o.toLowerCase());case"ends":return String(e).toLowerCase().endsWith(o.toLowerCase());case"regex":try{return new RegExp(o,"i").test(String(e))}catch(e){return console.warn("Invalid regex pattern:",o,e),!0}case"isnull":return null==e||""===e;case"isnotnull":return null!=e&&""!==e;case"gt":return Number(e)>Number(o);case"lt":return Number(e)<Number(o);case"gte":return Number(e)>=Number(o);case"lte":return Number(e)<=Number(o);default:return!0}};if(a(n))return!0;if(hierarchicalData&&hierarchicalData.children.length>0){const n=void 0!==e._id?e._id:parsedData.indexOf(e);return hierarchicalData.children.some(e=>e.data.filter(e=>e._parent_id===n).some(e=>{const n=e[t.column];return void 0!==n&&a(n)}))}return!1})));const t=document.getElementById("searchInput").value.toLowerCase();return t&&(e=e.filter(e=>{if(selectedColumns.some(n=>String(e[n]).toLowerCase().includes(t)))return!0;if(hierarchicalData&&hierarchicalData.children.length>0){const n=void 0!==e._id?e._id:parsedData.indexOf(e);return hierarchicalData.children.some(e=>e.data.filter(e=>e._parent_id===n).some(e=>Object.keys(e).some(n=>!n.startsWith("_")&&String(e[n]).toLowerCase().includes(t))))}return!1})),sortConfig.column&&e.sort((e,t)=>{let n=e[sortConfig.column],o=t[sortConfig.column];return"string"==typeof n&&(n=n.toLowerCase(),o=o.toLowerCase()),n<o?"asc"===sortConfig.direction?-1:1:n>o?"asc"===sortConfig.direction?1:-1:0}),e}function applySearch(){buildTable()}function sortTable(e){sortConfig.column===e?sortConfig.direction="asc"===sortConfig.direction?"desc":"asc":(sortConfig.column=e,sortConfig.direction="asc"),buildTable()}function getSortIndicator(e){return sortConfig.column!==e?"":"asc"===sortConfig.direction?"↑":"↓"}function addFilterRow(){filters.push({column:"",operator:"equals",value:""}),renderFilters(),toggleApplyButton()}function applyFilters(){buildTable(),showStatus("Filters applied successfully","success")}function toggleApplyButton(){const e=document.getElementById("applyFilterBtn");e&&(e.style.display=filters.length>0?"flex":"none")}function renderFilters(){const e=document.getElementById("filterList");e.innerHTML="",filters.forEach((t,n)=>{const o=document.createElement("div");o.className="filter-row",o.innerHTML=`\n            <select onchange="updateFilter(${n}, 'column', this.value)">\n                <option value="">Select Column</option>\n                ${allColumns.map(e=>`<option value="${e}" ${t.column===e?"selected":""}>${escapeHtml(e)}</option>`).join("")}\n            </select>\n            <select onchange="updateFilter(${n}, 'operator', this.value)">\n                <option value="equals" ${"equals"===t.operator?"selected":""}>Equals</option>\n                <option value="notequals" ${"notequals"===t.operator?"selected":""}>Not Equals</option>\n                <option value="contains" ${"contains"===t.operator?"selected":""}>Contains</option>\n                <option value="starts" ${"starts"===t.operator?"selected":""}>Starts with</option>\n                <option value="ends" ${"ends"===t.operator?"selected":""}>Ends with</option>\n                <option value="regex" ${"regex"===t.operator?"selected":""}>Regex Match</option>\n                <option value="isnull" ${"isnull"===t.operator?"selected":""}>IS NULL/Empty</option>\n                <option value="isnotnull" ${"isnotnull"===t.operator?"selected":""}>IS NOT NULL/Empty</option>\n                <option value="gt" ${"gt"===t.operator?"selected":""}>Greater than</option>\n                <option value="lt" ${"lt"===t.operator?"selected":""}>Less than</option>\n                <option value="gte" ${"gte"===t.operator?"selected":""}>≥</option>\n                <option value="lte" ${"lte"===t.operator?"selected":""}>≤</option>\n            </select>\n            <input type="text" placeholder="Filter value" value="${t.value}" onchange="updateFilter(${n}, 'value', this.value)">\n            <button class="btn-danger btn-sm" onclick="removeFilter(${n})" style="padding: 8px 12px;">×</button>\n        `,e.appendChild(o)})}function updateFilter(e,t,n){filters[e]&&(filters[e][t]=n)}function removeFilter(e){filters.splice(e,1),renderFilters(),toggleApplyButton(),applyFilters()}function updateStats(e){document.getElementById("statRows").textContent=parsedData.length,document.getElementById("statColumns").textContent=selectedColumns.length,document.getElementById("statFiltered").textContent=e.length}function formatCellValue(e){return null==e?"":"object"==typeof e?JSON.stringify(e).substring(0,50)+"...":String(e).substring(0,200)}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function initializePGLite(){try{if(console.log("[initializePGLite] Starting initialization..."),!window.PGlite)return console.log("[initializePGLite] PGlite not loaded yet, retrying in 500ms"),showStatus("PGLite library loading... Please wait","info"),void setTimeout(initializePGLite,500);console.log("[initializePGLite] PGlite loaded, initializing database..."),pgliteDB||(console.log("[initializePGLite] Creating new PGlite instance..."),pgliteDB=new window.PGlite,console.log("[initializePGLite] Testing database connection..."),await pgliteDB.query("SELECT 1"),console.log("[initializePGLite] Database connection successful")),console.log("[initializePGLite] Loading data into database..."),await reloadDatabase(),console.log("[initializePGLite] Initialization complete!")}catch(e){console.error("Database Error:",e),showStatus("Database initialization failed: "+e.message,"error")}}async function reloadDatabase(){try{if(!pgliteDB)return void showStatus("Database not initialized","error");showStatus("Populating records for DB query...","info",!0),tableMetadata=[],hierarchicalData&&hierarchicalData.children.length>0?await loadHierarchicalDataIntoPGLite():await loadSimpleDataIntoPGLite()}catch(e){console.error("Database reload error:",e),showStatus("Failed to load data into database: "+e.message,"error")}}async function loadSimpleDataIntoPGLite(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to load into database","error");try{await pgliteDB.query("DROP TABLE IF EXISTS json_data CASCADE")}catch(e){console.warn("Error dropping table:",e)}const t=selectedColumns.map(t=>{const n=e.find(e=>null!==e[t]&&void 0!==e[t]),o=n?n[t]:"";let a="TEXT";return"number"==typeof o?a="NUMERIC":"boolean"==typeof o&&(a="BOOLEAN"),`"${t}" ${a}`}).join(", "),n=`CREATE TABLE IF NOT EXISTS json_data (${t})`;try{await pgliteDB.query(n)}catch(e){console.warn("Error creating table, attempting to drop and recreate:",e);try{await pgliteDB.query("DROP TABLE json_data CASCADE"),await pgliteDB.query(`CREATE TABLE json_data (${t})`)}catch(e){throw new Error("Failed to create table: "+e.message)}}const o=`INSERT INTO json_data (${selectedColumns.map(e=>`"${e}"`).join(", ")}) VALUES (${selectedColumns.map((e,t)=>`$${t+1}`).join(", ")})`;for(const t of e){const e=selectedColumns.map(e=>{const n=t[e];return null==n?null:n});try{await pgliteDB.query(o,e)}catch(e){console.warn("Row insert error:",e)}}tableMetadata=[{name:"json_data",rowCount:e.length}],document.getElementById("querySection").classList.remove("hide"),document.getElementById("pgliteNotReady").classList.add("hide");document.getElementById("sqlQuery").placeholder=`SELECT * FROM json_data LIMIT 10;  -- Use table name: json_data (${e.length} rows)`,showStatus("Database loaded with "+e.length+" rows","success")}async function loadHierarchicalDataIntoPGLite(){const e=[hierarchicalData.parent.tableName];hierarchicalData.children.forEach(t=>e.push(t.tableName));for(const t of e)try{await pgliteDB.query(`DROP TABLE IF EXISTS ${t}`)}catch(e){}await createAndLoadTable(hierarchicalData.parent.tableName,hierarchicalData.parent.data,!1),tableMetadata.push({name:hierarchicalData.parent.tableName,rowCount:hierarchicalData.parent.data.length,type:"parent"});for(const e of hierarchicalData.children)await createAndLoadTable(e.tableName,e.data,!0),tableMetadata.push({name:e.tableName,rowCount:e.data.length,type:"child",parentTable:hierarchicalData.parent.tableName});document.getElementById("querySection").classList.remove("hide"),document.getElementById("pgliteNotReady").classList.add("hide");const t=document.getElementById("sqlQuery"),n=tableMetadata.map(e=>`${e.name} (${e.rowCount} rows)`).join(", ");t.placeholder=`SELECT * FROM ${hierarchicalData.parent.tableName} LIMIT 10;\n-- Available tables: ${n}`,updateAvailableTablesUI();const o=tableMetadata.reduce((e,t)=>e+t.rowCount,0);showStatus(`Database loaded with ${tableMetadata.length} tables, ${o} total rows`,"success")}function updateAvailableTablesUI(){const e=document.getElementById("availableTablesInfo"),t=document.getElementById("tablesList"),n=document.getElementById("joinExamples");if(tableMetadata.length>1){e.style.display="block";let o="";const a=tableMetadata.find(e=>"parent"===e.type),r=tableMetadata.filter(e=>"child"===e.type);if(a&&(o+=`<div>• <strong>${a.name}</strong> (${a.rowCount} rows) - Parent table</div>`),r.forEach(e=>{o+=`<div>• <strong>${e.name}</strong> (${e.rowCount} rows) - Child of ${e.parentTable}</div>`}),t.innerHTML=o,a&&r.length>0){n.style.display="block";const e=r[0];if(document.getElementById("joinExample1").textContent=`SELECT * FROM ${a.name} p JOIN ${e.name} c ON p._id = c._parent_id`,r.length>1){const t=r[1];document.getElementById("joinExample2").textContent=`SELECT p.*, c1.*, c2.* FROM ${a.name} p JOIN ${e.name} c1 ON p._id = c1._parent_id JOIN ${t.name} c2 ON p._id = c2._parent_id`}}}else e.style.display="none",n.style.display="none"}async function createAndLoadTable(e,t,n){if(0===t.length)return;const o=new Set;t.forEach(e=>{Object.keys(e).forEach(e=>o.add(e))});const a=`CREATE TABLE ${e} (${Array.from(o).map(e=>{const n=t.find(t=>null!==t[e]&&void 0!==t[e]),o=n?n[e]:"";let a="TEXT";return"number"==typeof o?a="NUMERIC":"boolean"==typeof o&&(a="BOOLEAN"),`"${e}" ${a}`}).join(", ")})`;await pgliteDB.query(a);const r=Array.from(o),l=`INSERT INTO ${e} (${r.map(e=>`"${e}"`).join(", ")}) VALUES (${r.map((e,t)=>`$${t+1}`).join(", ")})`;for(const e of t){const t=r.map(t=>{const n=e[t];return null==n?null:n});try{await pgliteDB.query(l,t)}catch(e){console.warn("Row insert error:",e)}}}async function executeSQLQuery(){const e=document.getElementById("queryError");e.classList.add("hide"),e.textContent="";try{if(!pgliteDB)return void showQueryError("Database not initialized yet. Please wait and try again.");const e=document.getElementById("sqlQuery").value.trim();if(!e)return void showQueryError("Please enter a SQL query");try{const t=await pgliteDB.query(e),n=t.rows||t||[];displayQueryResult(Array.isArray(n)?n:[]),showStatus("Query executed successfully","success"),setTimeout(()=>{document.getElementById("queryResult").scrollIntoView({behavior:"smooth",block:"start"})},100)}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("Query error: "+e.message)}}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("Query error: "+e.message)}}function switchQueryMode(e){document.querySelectorAll(".query-mode-btn").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-mode")===e)}),"sql"===e?(document.getElementById("sqlSection").classList.remove("hide"),document.getElementById("jsonpathSection").classList.add("hide")):"jsonpath"===e&&(document.getElementById("sqlSection").classList.add("hide"),document.getElementById("jsonpathSection").classList.remove("hide")),document.getElementById("queryError").classList.add("hide"),document.getElementById("queryError").textContent=""}function executeJSONPathQuery(){const e=document.getElementById("queryError");e.classList.add("hide"),e.textContent="";try{if(!jsonData)return void showQueryError("No JSON data loaded. Please parse JSON first.");const e=document.getElementById("jsonpathQuery").value.trim();if(!e)return void showQueryError("Please enter a JSONPath query");if(!window.jsonpath)return showQueryError("JSONPath library not loaded. Please refresh the page."),void console.error("window.jsonpath is not available. Available:",Object.keys(window).filter(e=>e.toLowerCase().includes("json")));try{const t=window.jsonpath.query(jsonData,e);if(t&&0!==t.length){const e=normalizeJSONPathResult(t);displayQueryResult(e),showStatus(`Query executed successfully (${e.length} results)`,"success")}else displayQueryResult([]),showStatus("Query executed successfully (0 results)","success");setTimeout(()=>{document.getElementById("queryResult").scrollIntoView({behavior:"smooth",block:"start"})},100)}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("JSONPath query error: "+e.message)}}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("Query error: "+e.message)}}function normalizeJSONPathResult(e){return Array.isArray(e)&&e.length>0&&"object"==typeof e[0]&&null!==e[0]&&!Array.isArray(e[0])?e:Array.isArray(e)||"object"!=typeof e||null===e?Array.isArray(e)?e.map((e,t)=>"object"!=typeof e||null===e||Array.isArray(e)?{index:t,value:e}:e):[{value:e}]:[e]}function showQueryError(e){const t=document.getElementById("queryError"),n=document.getElementById("queryPanel"),o=document.getElementById("querySection");if(t.textContent=e,t.classList.remove("hide"),n.classList.contains("collapsed")){n.classList.remove("collapsed");const e=document.getElementById("querySectionToggle");e&&(e.textContent="Hide Section")}o&&o.classList.contains("hide")&&o.classList.remove("hide"),setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},100)}let currentQueryResults=null;function displayQueryResult(e){const t=document.getElementById("resultContent"),n=document.getElementById("queryResult");if(currentQueryResults=e,e&&0!==e.length){let n="<table><thead><tr>";const o=Object.keys(e[0]);o.forEach(e=>{n+=`<th>${escapeHtml(String(e))}</th>`}),n+="</tr></thead><tbody>";const a=e.slice(0,1e3);a.forEach(e=>{n+="<tr>",o.forEach(t=>{const o=e[t],a=null==o?"NULL":String(o);n+=`<td>${escapeHtml(a)}</td>`}),n+="</tr>"}),n+="</tbody></table>",e.length>a.length?n+=`<div style="color: var(--text-secondary); padding: 8px; font-size: 11px; margin-top: 8px;">Showing ${a.length} of ${e.length} rows</div>`:n+=`<div style="color: var(--text-secondary); padding: 8px; font-size: 11px; margin-top: 8px;">${e.length} row${1!==e.length?"s":""}</div>`,t.innerHTML=n}else t.innerHTML='<div style="color: var(--text-secondary); padding: 12px; text-align: center;">(0 rows)</div>';n.classList.remove("hide")}function exportToCSV(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to export","error");let t=selectedColumns.map(e=>`"${e.replace(/"/g,'""')}"`).join(",")+"\n";e.forEach(e=>{t+=selectedColumns.map(t=>{const n=e[t];return`"${String(n).replace(/"/g,'""')}"`}).join(",")+"\n"}),downloadFile(t,"data.csv","text/csv")}function exportToJSON(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to export","error");downloadFile(JSON.stringify(e,null,2),"data.json","application/json")}function copyAsMarkdown(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to copy","error");let t="";t+="| "+selectedColumns.join(" | ")+" |\n",t+="| "+selectedColumns.map(()=>"---").join(" | ")+" |\n",e.forEach(e=>{const n=selectedColumns.map(t=>{const n=e[t];return null==n?"":String(n).replace(/\|/g,"\\|").replace(/\n/g," ")});t+="| "+n.join(" | ")+" |\n"}),copyToClipboard(t,"Markdown table copied to clipboard!")}function copyAsJSON(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to copy","error");copyToClipboard(JSON.stringify(e,null,2),"JSON copied to clipboard!")}function copyToClipboard(e,t){if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).then(()=>{showStatus(t,"success")}).catch(e=>{console.error("Failed to copy to clipboard:",e),showStatus("Failed to copy to clipboard","error")});else{const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy")?showStatus(t,"success"):showStatus("Failed to copy to clipboard","error")}catch(e){console.error("Failed to copy to clipboard:",e),showStatus("Failed to copy to clipboard","error")}document.body.removeChild(n)}}function downloadFile(e,t,n){const o=new Blob([e],{type:n}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),showStatus(`Exported as ${t}`,"success")}function clearInput(){document.getElementById("jsonInput").value="",document.getElementById("fileInput").value="",jsonData=null,parsedData=[],selectedColumns=[],allColumns=[],filters=[],document.getElementById("tableContainer").classList.add("hide"),document.getElementById("noData").classList.add("hide"),document.getElementById("columnSelector").classList.add("hide"),document.getElementById("filterControls").classList.add("hide"),document.getElementById("querySection").classList.add("hide"),document.getElementById("detailsEmpty").classList.remove("hide"),document.getElementById("detailsStatusMessage").classList.remove("show"),renderFilters(),toggleApplyButton(),document.getElementById("statRows").textContent="0",document.getElementById("statColumns").textContent="0",document.getElementById("statFiltered").textContent="0",document.getElementById("statsContainer").style.display="none"}function showLoader(){document.getElementById("loadingOverlay").style.display="block"}function hideLoader(){document.getElementById("loadingOverlay").style.display="none"}function openHelpModal(e){e&&(e.preventDefault(),e.stopPropagation()),document.getElementById("helpModal").style.display="block",document.body.style.overflow="hidden"}function closeHelpModal(){document.getElementById("helpModal").style.display="none",document.body.style.overflow="auto"}function openFAQModal(e){e&&(e.preventDefault(),e.stopPropagation()),document.getElementById("faqModal").style.display="block",document.body.style.overflow="hidden"}function closeFAQModal(){document.getElementById("faqModal").style.display="none",document.body.style.overflow="auto"}function detectComplexStructure(e,t=0,n=0){return analyzeStructure(e).hasMultipleNestedArrays}function changeDisplayMode(){const e=document.querySelector('input[name="displayMode"]:checked').value;displayMode=e,jsonData&&(normalizeData(),detectStructure(),buildColumns(),buildTable(),pgliteDB&&parsedData.length>0&&loadDataIntoPGLite())}function exportQueryToCSV(){if(!currentQueryResults||0===currentQueryResults.length)return void showStatus("No query results to export","error");const e=Object.keys(currentQueryResults[0]);let t=e.map(e=>`"${e.replace(/"/g,'""')}"`).join(",")+"\n";currentQueryResults.forEach(n=>{t+=e.map(e=>{const t=n[e];return`"${String(null==t?"":t).replace(/"/g,'""')}"`}).join(",")+"\n"}),downloadFile(t,"query-results.csv","text/csv")}function exportQueryToJSON(){if(!currentQueryResults||0===currentQueryResults.length)return void showStatus("No query results to export","error");downloadFile(JSON.stringify(currentQueryResults,null,2),"query-results.json","application/json")}function copyQueryAsJSON(){if(!currentQueryResults||0===currentQueryResults.length)return void showStatus("No query results to copy","error");copyToClipboard(JSON.stringify(currentQueryResults,null,2),"Query results JSON copied to clipboard!")}function copyQueryAsMarkdown(){if(!currentQueryResults||0===currentQueryResults.length)return void showStatus("No query results to copy","error");const e=Object.keys(currentQueryResults[0]);let t="";t+="| "+e.join(" | ")+" |\n",t+="| "+e.map(()=>"---").join(" | ")+" |\n",currentQueryResults.forEach(n=>{const o=e.map(e=>{const t=n[e];return null==t?"NULL":String(t).replace(/\|/g,"\\|").replace(/\n/g," ")});t+="| "+o.join(" | ")+" |\n"}),copyToClipboard(t,"Query results Markdown table copied to clipboard!")}window.addEventListener("click",function(e){const t=document.getElementById("helpModal"),n=document.getElementById("faqModal");e.target===t?closeHelpModal():e.target===n&&closeFAQModal()}),document.addEventListener("keydown",function(e){"Escape"===e.key&&(closeHelpModal(),closeFAQModal())});