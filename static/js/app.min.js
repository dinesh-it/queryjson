let jsonData=null,parsedData=[],allColumns=[],selectedColumns=[],filters=[],pgliteDB=null,sortConfig={column:null,direction:"asc"},displayMode="grouped",isComplexStructure=!1,hierarchicalData=null,tableMetadata=[];const defaultJSON={users:[{id:1,name:"Alice Johnson",email:"alice@example.com",department:"Engineering",salary:95e3,joinDate:"2021-03-15"},{id:2,name:"Bob Smith",email:"bob@example.com",department:"Marketing",salary:75e3,joinDate:"2021-06-20"},{id:3,name:"Carol White",email:"carol@example.com",department:"Engineering",salary:98e3,joinDate:"2020-01-10"},{id:4,name:"David Brown",email:"david@example.com",department:"Sales",salary:85e3,joinDate:"2022-02-14"},{id:5,name:"Eve Davis",email:"eve@example.com",department:"Engineering",salary:92e3,joinDate:"2021-11-05"}]};function setupEventListeners(){document.getElementById("fileInput").addEventListener("change",e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{document.getElementById("jsonInput").value=e.target.result},e.readAsText(t)}});const e=document.getElementById("sqlQuery");e&&(e.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),executeSQLQuery())}),e.addEventListener("input",function(){this.style.height="32px",this.style.height=Math.min(this.scrollHeight,200)+"px"}));const t=document.getElementById("jsonpathQuery");t&&(t.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),executeJSONPathQuery())}),t.addEventListener("input",function(){this.style.height="32px",this.style.height=Math.min(this.scrollHeight,200)+"px"}))}function loadDefaultJSON(){document.getElementById("jsonInput").value=JSON.stringify(defaultJSON,null,2),setTimeout(()=>{parseJSON()},100)}function toggleTopSection(){const e=document.getElementById("topSection"),t=document.getElementById("topSectionToggle");e.classList.toggle("collapsed"),e.classList.contains("collapsed")?t.textContent="Show Section":t.textContent="Hide Section"}function toggleOutputSection(){const e=document.getElementById("outputPanel"),t=document.getElementById("outputSectionToggle");e.classList.toggle("collapsed"),e.classList.contains("collapsed")?t.textContent="Show Section":t.textContent="Hide Section"}function toggleQuerySection(){const e=document.getElementById("queryPanel"),t=document.getElementById("querySectionToggle");e.classList.toggle("collapsed"),e.classList.contains("collapsed")?t.textContent="Show Section":t.textContent="Hide Section"}function showStatus(e,t="success",n=!1){const a=document.getElementById("detailsStatusMessage");a.textContent=e,a.className=`status-message show ${t}`,"error"===t||n||setTimeout(()=>{a.classList.remove("show")},3e3)}function parseJSON(){showLoader(),setTimeout(()=>{try{const e=document.getElementById("jsonInput").value.trim();if(!e)return hideLoader(),void showStatus("Please paste or upload JSON/XML/CSV data","error");if(e.startsWith("<?xml")||e.startsWith("<"))return void parseXML(e);if(!e.startsWith("{")&&!e.startsWith("[")&&(e.includes(",")||e.includes("\t")))return void parseCSV(e);jsonData=JSON.parse(e),isComplexStructure=detectComplexStructure(jsonData);const t=document.getElementById("displayModeSelector");isComplexStructure?t.classList.remove("hide"):t.classList.add("hide"),filters=[],normalizeData(),detectStructure(),buildColumns(),renderFilters(),toggleApplyButton(),buildTable(),initializePGLite(),hideLoader(),showStatus("JSON parsed successfully! "+parsedData.length+" records found.","success")}catch(e){hideLoader(),showStatus("Invalid JSON: "+e.message,"error")}},50)}function parseXML(e){try{const t=(new DOMParser).parseFromString(e,"text/xml"),n=t.getElementsByTagName("parsererror");if(n.length>0)throw hideLoader(),new Error("XML parsing error: "+n[0].textContent);jsonData=xmlToJson(t),document.getElementById("jsonInput").value=JSON.stringify(jsonData,null,2),filters=[],normalizeData(),detectStructure(),buildColumns(),renderFilters(),toggleApplyButton(),buildTable(),initializePGLite(),hideLoader(),showStatus("XML converted and parsed successfully! "+parsedData.length+" records found.","success")}catch(e){hideLoader(),showStatus("Invalid XML: "+e.message,"error")}}function xmlToJson(e){let t={};if(1===e.nodeType){if(e.attributes.length>0)for(let n=0;n<e.attributes.length;n++){const a=e.attributes.item(n);t[a.nodeName]=a.nodeValue}}else 3===e.nodeType&&(t=e.nodeValue.trim());if(e.hasChildNodes())for(let n=0;n<e.childNodes.length;n++){const a=e.childNodes.item(n),o=a.nodeName;if(3===a.nodeType){const e=a.nodeValue.trim();if(e){if(!(Object.keys(t).length>0))return e;t.value=e}continue}if(void 0===t[o]){const e=xmlToJson(a);t[o]=e}else Array.isArray(t[o])||(t[o]=[t[o]]),t[o].push(xmlToJson(a))}return t}function parseCSV(e){try{const t=e.split("\n").filter(e=>e.trim());if(0===t.length)throw hideLoader(),new Error("CSV data is empty");const n=t[0];let a=",";n.includes("\t")?a="\t":n.includes(";")&&n.split(";").length>n.split(",").length&&(a=";");const o=parseCSVRow(t[0],a),r=[];for(let e=1;e<t.length;e++){const n=parseCSVRow(t[e],a);if(0===n.length||1===n.length&&""===n[0])continue;const l={};o.forEach((e,t)=>{let a=n[t]||"";if(""!==a&&!isNaN(a)&&""!==a.trim()){const e=parseFloat(a);isNaN(e)||(a=e)}l[e]=a}),r.push(l)}jsonData={data:r},document.getElementById("jsonInput").value=JSON.stringify(jsonData,null,2),filters=[],normalizeData(),detectStructure(),buildColumns(),renderFilters(),toggleApplyButton(),buildTable(),initializePGLite(),hideLoader(),showStatus("CSV converted and parsed successfully! "+parsedData.length+" records found.","success")}catch(e){hideLoader(),showStatus("Invalid CSV: "+e.message,"error")}}function parseCSVRow(e,t){const n=[];let a="",o=!1;for(let r=0;r<e.length;r++){const l=e[r],s=e[r+1];'"'===l?o&&'"'===s?(a+='"',r++):o=!o:l!==t||o?a+=l:(n.push(a.trim()),a="")}return n.push(a.trim()),n}function normalizeData(){if(containsArrays(jsonData))if("grouped"===displayMode){const e=analyzeStructure(jsonData);e.hasMultipleNestedArrays?(hierarchicalData=buildHierarchicalData(jsonData,e),parsedData=hierarchicalData.parent.data):(hierarchicalData=null,parsedData=normalizeDataGrouped(jsonData))}else{hierarchicalData=null;const e=pathsToCSV(flattenToLeafPaths(jsonData));parsedData=csvToRows(e)}else{hierarchicalData=null;const e=pathsToCSV(flattenToLeafPaths(jsonData));parsedData=csvToRows(e)}}function analyzeStructure(e,t="",n=0){const a={hasMultipleNestedArrays:!1,nestedArrays:[],rootArray:null};let o=e;if("object"==typeof e&&null!==e&&!Array.isArray(e)&&""===t){const t=Object.keys(e);if(1===t.length){const n=e[t[0]];(Array.isArray(n)||"object"==typeof n&&null!==n&&containsArrays(n))&&(o=n)}}if(Array.isArray(o)){if(a.rootArray=t||"root",o.length>0&&"object"==typeof o[0]&&null!==o[0]){const e=[];for(const[t,n]of Object.entries(o[0]))if(Array.isArray(n))e.push(t);else if("object"==typeof n&&null!==n){const a=Object.keys(n);(1===a.length&&Array.isArray(n[a[0]])||Object.values(n).some(e=>Array.isArray(e)))&&e.push(t)}e.length>1&&(a.hasMultipleNestedArrays=!0);for(const[e,r]of Object.entries(o[0]))if("object"==typeof r&&null!==r){const o=analyzeStructure(r,e,n+1);a.nestedArrays.push(...o.nestedArrays),Array.isArray(r)&&a.nestedArrays.push({path:e,parentPath:t||"root",name:e,depth:n+1})}}}else if("object"==typeof o&&null!==o){Object.entries(o).filter(([e,t])=>Array.isArray(t)).length>1&&(a.hasMultipleNestedArrays=!0);for(const[e,r]of Object.entries(o))if("object"==typeof r&&null!==r){const o=analyzeStructure(r,t?`${t}.${e}`:e,n+1);o.hasMultipleNestedArrays&&(a.hasMultipleNestedArrays=!0),a.nestedArrays.push(...o.nestedArrays),o.rootArray&&a.nestedArrays.push({path:t?`${t}.${e}`:e,parentPath:t||"root",name:e,depth:n+1})}}return a}function buildHierarchicalData(e,t){const n={parent:{name:"parent",data:[],tableName:"parent"},children:[]};let a=e;if("object"==typeof e&&null!==e&&!Array.isArray(e)){const t=Object.keys(e);if(1===t.length){const n=e[t[0]];(Array.isArray(n)||"object"==typeof n&&null!==n&&containsArrays(n))&&(a=n)}}let o=[],r="";if(Array.isArray(a))o=a,r="items";else if("object"==typeof a&&null!==a)for(const[e,t]of Object.entries(a)){if(Array.isArray(t)){o=t,r=e;break}if("object"==typeof t&&null!==t){for(const[e,n]of Object.entries(t))if(Array.isArray(n)){o=n,r=e;break}if(o.length>0)break}}return 0===o.length?(n.parent.data=[a],n):(o.forEach((e,t)=>{if("object"!=typeof e||null===e)return;const a={_id:t},o={};for(const[t,n]of Object.entries(e))if(Array.isArray(n))o[t]=n;else if("object"==typeof n&&null!==n){const e=Object.keys(n);if(1===e.length&&Array.isArray(n[e[0]]))o[e[0]]=n[e[0]];else{let e=!1;for(const[t,a]of Object.entries(n))Array.isArray(a)&&(o[t]=a,e=!0);e||flattenObjectProperties(n,t,a,"")}}else a[t]=n;n.parent.data.push(a);for(const[e,a]of Object.entries(o)){let o=n.children.find(t=>t.name===e);o||(o={name:e,tableName:toSnakeCase(e),data:[],parentKey:"_parent_id"},n.children.push(o)),a.forEach((e,n)=>{const a={_id:o.data.length,_parent_id:t};if("object"!=typeof e||null===e||Array.isArray(e))a.value=e;else for(const[t,n]of Object.entries(e))Array.isArray(n)||"object"==typeof n&&null!==n||(a[t]=n);o.data.push(a)})}}),n.parent.tableName=toSnakeCase(r)||"parent",n)}function toSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"").replace(/\s+/g,"_")}function normalizeDataGrouped(e,t="",n={}){const a=[];let o=e;if("object"==typeof e&&null!==e&&!Array.isArray(e)&&""===t){const t=Object.keys(e);if(1===t.length){const n=e[t[0]];if(Array.isArray(n))o=n;else if("object"==typeof n&&null!==n){containsArrays(n)&&(o=n)}}}if(Array.isArray(o))o.forEach((e,o)=>{const r=`${t}_Index`,l={...n,[r]:o};if("object"!=typeof e||null===e||Array.isArray(e))if(Array.isArray(e)){const n=normalizeDataGrouped(e,t,l);a.push(...n)}else l[`${t}_Value`]=e,a.push(l);else{const n={...l};flattenObjectProperties(e,"",n,t);const o=findAndProcessNestedArrays(e,t,n);o.length>0?a.push(...o):a.push(n)}});else if("object"==typeof o&&null!==o){if(Object.values(o).some(e=>Array.isArray(e)||"object"==typeof e&&null!==e)){for(const[e,t]of Object.entries(o))if(Array.isArray(t)){const o=normalizeDataGrouped(t,e,n);a.push(...o)}else if("object"==typeof t&&null!==t){const o=normalizeDataGrouped(t,e,n);a.push(...o)}}else{const e={};flattenObjectProperties(o,"",e,""),a.push(e)}}return a.length>0?a:[{Value:o}]}function flattenObjectProperties(e,t,n,a){for(const[o,r]of Object.entries(e)){const e=t?`${t}.${o}`:a?`${removeArraySuffix(a)}.${o}`:o;"object"!=typeof r||null===r||Array.isArray(r)?Array.isArray(r)||(n[e]=r):flattenObjectProperties(r,e,n,a)}}function findAndProcessNestedArrays(e,t,n){const a=[];for(const[o,r]of Object.entries(e))if(Array.isArray(r)){const e=normalizeDataGrouped(r,o,n);a.push(...e)}else if("object"==typeof r&&null!==r){const e=findAndProcessNestedArrays(r,t,n);e.length>0&&a.push(...e)}return a}function removeArraySuffix(e){return e.endsWith("s")&&e.length>2?e.slice(0,-1):e}function containsArrays(e){if(Array.isArray(e))return!0;if("object"!=typeof e||null===e)return!1;for(const t of Object.values(e)){if(Array.isArray(t))return!0;if("object"==typeof t&&null!==t&&containsArrays(t))return!0}return!1}function flattenToLeafPaths(e,t=""){let n={};if(null==e)return{[t]:e};if("object"!=typeof e)return{[t]:e};if(Array.isArray(e))return e.forEach((e,a)=>{const o=t?`${t}[${a}]`:`[${a}]`;Object.assign(n,flattenToLeafPaths(e,o))}),n;const a=Object.keys(e);let o=!1;return a.forEach(a=>{const r=e[a],l=t?`${t}.${a}`:a;null==r?n[l]=r:"object"==typeof r?(o=!0,Object.assign(n,flattenToLeafPaths(r,l))):n[l]=r}),n}function pathsToCSV(e){const t=[];for(let n in e){const a=e[n],o=n.split(/\.|\[/).map(e=>e.endsWith("]")?"["+e.slice(0,-1)+"]":e).filter(e=>""!==e),r={};o.forEach((e,t)=>{t<o.length-1?r[`path_${t}`]=e:r.metric=e}),r.value=a,t.push(r)}return t}function csvToRows(e){if(0===e.length)return[];let t=0;e.forEach(e=>{let n=0;for(;void 0!==e[`path_${n}`];)n++,t=Math.max(t,n)});const n=new Set;e.forEach(e=>{void 0!==e.path_0&&n.add(e.path_0)});const a=1===n.size,o={};e.forEach(e=>{const n=[];for(let a=0;a<t;a++)void 0!==e[`path_${a}`]&&n.push(e[`path_${a}`]);const r=n.join("|");let l;if(o[r]||(o[r]={},n.forEach((e,t)=>{o[r][`path_${t}`]=e})),a){const n=[];for(let a=1;a<t;a++){const t=e[`path_${a}`];void 0===t||t.match(/^\[\d+\]$/)||n.push(t)}n.push(e.metric),l=n.join(".")}else l=e.metric;o[r][l]=e.value});const r=Object.values(o);return r.forEach(e=>{if(a)for(let n=0;n<t;n++)delete e[`path_${n}`];else for(let n=0;n<t;n++)void 0!==e[`path_${n}`]&&(e[`Key${n+1}`]=e[`path_${n}`],delete e[`path_${n}`])}),r}function detectStructure(){if(0===parsedData.length)return;const e=document.getElementById("detailsEmpty");e&&e.classList.add("hide")}function buildColumns(){if(allColumns=[],0===parsedData.length)return;const e=new Set;parsedData.forEach(t=>{"object"==typeof t&&null!==t&&Object.keys(t).forEach(t=>e.add(t))}),allColumns=Array.from(e).sort((e,t)=>{const n=e.match(/^Key(\d+)$/),a=t.match(/^Key(\d+)$/),o=e.endsWith("_Index"),r=t.endsWith("_Index");return o&&!r?-1:!o&&r?1:n&&a?parseInt(n[1])-parseInt(a[1]):n?-1:a?1:e.localeCompare(t)}),selectedColumns=[...allColumns],renderColumnList(),document.getElementById("columnSelector").classList.remove("hide"),document.getElementById("filterControls").classList.remove("hide")}function renderColumnList(){const e=document.getElementById("columnList");e.innerHTML="",allColumns.forEach((t,n)=>{const a=document.createElement("div");a.className="column-item",a.draggable=!0,a.dataset.columnIndex=n,a.dataset.columnName=t,a.innerHTML=`\n            <span class="drag-handle">⋮⋮</span>\n            <input type="checkbox" id="col_${t}" checked onchange="updateSelectedColumns()">\n            <label for="col_${t}">${escapeHtml(t)}</label>\n        `,a.addEventListener("dragstart",handleDragStart),a.addEventListener("dragover",handleDragOver),a.addEventListener("drop",handleDrop),a.addEventListener("dragend",handleDragEnd),a.addEventListener("dragenter",handleDragEnter),a.addEventListener("dragleave",handleDragLeave),e.appendChild(a)})}document.addEventListener("DOMContentLoaded",()=>{setupEventListeners(),loadDefaultJSON()});let draggedElement=null;function handleDragStart(e){draggedElement=this,this.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function handleDragEnter(e){this!==draggedElement&&this.classList.add("drag-over")}function handleDragLeave(e){this.classList.remove("drag-over")}function handleDrop(e){if(e.preventDefault(),this!==draggedElement){const e=parseInt(draggedElement.dataset.columnIndex),t=parseInt(this.dataset.columnIndex);[allColumns[e],allColumns[t]]=[allColumns[t],allColumns[e]],renderColumnList(),updateSelectedColumns()}}function handleDragEnd(e){this.classList.remove("dragging"),document.querySelectorAll(".column-item").forEach(e=>{e.classList.remove("drag-over")}),draggedElement=null}function updateSelectedColumns(){selectedColumns=[],allColumns.forEach(e=>{const t=document.getElementById(`col_${e}`);t&&t.checked&&selectedColumns.push(e)}),buildTable()}function selectAllColumns(){allColumns.forEach(e=>{const t=document.getElementById(`col_${e}`);t&&(t.checked=!0)}),updateSelectedColumns()}function deselectAllColumns(){allColumns.forEach(e=>{const t=document.getElementById(`col_${e}`);t&&(t.checked=!1)}),updateSelectedColumns()}function buildTable(){document.getElementById("tableHead"),document.getElementById("tableBody");const e=document.getElementById("tableContainer"),t=document.getElementById("noData");let n=getFilteredData();if(0===selectedColumns.length||0===n.length)return e.classList.add("hide"),t.classList.remove("hide"),void(document.getElementById("statsContainer").style.display="none");hierarchicalData&&hierarchicalData.children.length>0?buildHierarchicalTable(n):buildSimpleTable(n),e.classList.remove("hide"),t.classList.add("hide"),updateStats(n),document.getElementById("statsContainer").style.display="grid"}function buildSimpleTable(e){const t=document.getElementById("tableHead"),n=document.getElementById("tableBody");t.innerHTML="",selectedColumns.forEach(e=>{const n=document.createElement("th");n.innerHTML=`${escapeHtml(e)} <span class="sort-indicator">${getSortIndicator(e)}</span>`,n.onclick=()=>sortTable(e),t.appendChild(n)}),n.innerHTML="",e.forEach(e=>{const t=document.createElement("tr");selectedColumns.forEach(n=>{const a=document.createElement("td"),o=e[n];a.textContent=formatCellValue(o),t.appendChild(a)}),n.appendChild(t)})}function buildHierarchicalTable(e){const t=document.getElementById("tableHead"),n=document.getElementById("tableBody");t.innerHTML="";const a=document.createElement("th");a.style.width="40px",a.textContent="",t.appendChild(a),selectedColumns.forEach(e=>{const n=document.createElement("th");n.innerHTML=`${escapeHtml(e)} <span class="sort-indicator">${getSortIndicator(e)}</span>`,n.onclick=()=>sortTable(e),t.appendChild(n)}),n.innerHTML="",e.forEach((e,t)=>{const a=document.createElement("tr");a.dataset.rowId=void 0!==e._id?e._id:t;const o=document.createElement("td");o.style.textAlign="center",o.style.cursor="pointer",o.innerHTML='<span class="expand-icon">▶</span>',o.onclick=()=>toggleChildTables(a,void 0!==e._id?e._id:t),a.appendChild(o),selectedColumns.forEach(t=>{const n=document.createElement("td"),o=e[t];n.textContent=formatCellValue(o),a.appendChild(n)}),n.appendChild(a)})}function toggleChildTables(e,t){const n=e.querySelector(".expand-icon"),a=e.nextElementSibling;if(a&&a.classList.contains("child-tables-row"))a.remove(),n.textContent="▶";else{n.textContent="▼";const a=document.createElement("tr");a.classList.add("child-tables-row");const o=document.createElement("td");o.colSpan=selectedColumns.length+1,o.style.padding="0",o.style.background="var(--bg-secondary)";const r=document.createElement("div");r.style.padding="12px",r.style.display="grid",r.style.gap="16px",hierarchicalData.children.forEach(e=>{const n=e.data.filter(e=>e._parent_id===t);if(0===n.length)return;const a=document.createElement("div");a.style.border="1px solid var(--border-color)",a.style.borderRadius="4px",a.style.overflow="hidden";const o=document.createElement("div");o.style.padding="8px 12px",o.style.background="var(--bg-tertiary)",o.style.fontWeight="600",o.style.fontSize="12px",o.style.borderBottom="1px solid var(--border-color)",o.textContent=`${e.name} (${n.length} rows)`;const l=document.createElement("table");l.style.width="100%",l.style.fontSize="11px";const s=Object.keys(n[0]).filter(e=>!e.startsWith("_")),i=document.createElement("thead"),c=document.createElement("tr");s.forEach(e=>{const t=document.createElement("th");t.textContent=e,t.style.padding="6px 8px",t.style.background="var(--bg-primary)",t.style.borderBottom="1px solid var(--border-color)",t.style.textAlign="left",c.appendChild(t)}),i.appendChild(c),l.appendChild(i);const d=document.createElement("tbody");n.forEach(e=>{const t=document.createElement("tr");s.forEach(n=>{const a=document.createElement("td");a.textContent=formatCellValue(e[n]),a.style.padding="6px 8px",a.style.borderBottom="1px solid var(--border-color)",t.appendChild(a)}),d.appendChild(t)}),l.appendChild(d),a.appendChild(o),a.appendChild(l),r.appendChild(a)}),o.appendChild(r),a.appendChild(o),e.parentNode.insertBefore(a,e.nextSibling)}}function getFilteredData(){let e=[...parsedData];filters.length>0&&(e=e.filter(e=>filters.every(t=>{if(!t.column||!t.operator)return!0;if(["equals","notequals","contains","starts","ends","gt","lt","gte","lte"].includes(t.operator)&&""===t.value)return!0;const n=e[t.column],a=t.value,o=e=>{switch(t.operator){case"equals":return String(e).toLowerCase()===a.toLowerCase();case"notequals":return String(e).toLowerCase()!==a.toLowerCase();case"contains":return String(e).toLowerCase().includes(a.toLowerCase());case"starts":return String(e).toLowerCase().startsWith(a.toLowerCase());case"ends":return String(e).toLowerCase().endsWith(a.toLowerCase());case"isnull":return null==e||""===e;case"isnotnull":return null!=e&&""!==e;case"gt":return Number(e)>Number(a);case"lt":return Number(e)<Number(a);case"gte":return Number(e)>=Number(a);case"lte":return Number(e)<=Number(a);default:return!0}};if(o(n))return!0;if(hierarchicalData&&hierarchicalData.children.length>0){const n=void 0!==e._id?e._id:parsedData.indexOf(e);return hierarchicalData.children.some(e=>e.data.filter(e=>e._parent_id===n).some(e=>{const n=e[t.column];return void 0!==n&&o(n)}))}return!1})));const t=document.getElementById("searchInput").value.toLowerCase();return t&&(e=e.filter(e=>{if(selectedColumns.some(n=>String(e[n]).toLowerCase().includes(t)))return!0;if(hierarchicalData&&hierarchicalData.children.length>0){const n=void 0!==e._id?e._id:parsedData.indexOf(e);return hierarchicalData.children.some(e=>e.data.filter(e=>e._parent_id===n).some(e=>Object.keys(e).some(n=>!n.startsWith("_")&&String(e[n]).toLowerCase().includes(t))))}return!1})),sortConfig.column&&e.sort((e,t)=>{let n=e[sortConfig.column],a=t[sortConfig.column];return"string"==typeof n&&(n=n.toLowerCase(),a=a.toLowerCase()),n<a?"asc"===sortConfig.direction?-1:1:n>a?"asc"===sortConfig.direction?1:-1:0}),e}function applySearch(){buildTable()}function sortTable(e){sortConfig.column===e?sortConfig.direction="asc"===sortConfig.direction?"desc":"asc":(sortConfig.column=e,sortConfig.direction="asc"),buildTable()}function getSortIndicator(e){return sortConfig.column!==e?"":"asc"===sortConfig.direction?"↑":"↓"}function addFilterRow(){filters.push({column:"",operator:"equals",value:""}),renderFilters(),toggleApplyButton()}function applyFilters(){buildTable(),showStatus("Filters applied successfully","success")}function toggleApplyButton(){const e=document.getElementById("applyFilterBtn");e&&(e.style.display=filters.length>0?"flex":"none")}function renderFilters(){const e=document.getElementById("filterList");e.innerHTML="",filters.forEach((t,n)=>{const a=document.createElement("div");a.className="filter-row",a.innerHTML=`\n            <select onchange="updateFilter(${n}, 'column', this.value)">\n                <option value="">Select Column</option>\n                ${allColumns.map(e=>`<option value="${e}" ${t.column===e?"selected":""}>${escapeHtml(e)}</option>`).join("")}\n            </select>\n            <select onchange="updateFilter(${n}, 'operator', this.value)">\n                <option value="equals" ${"equals"===t.operator?"selected":""}>Equals</option>\n                <option value="notequals" ${"notequals"===t.operator?"selected":""}>Not Equals</option>\n                <option value="contains" ${"contains"===t.operator?"selected":""}>Contains</option>\n                <option value="starts" ${"starts"===t.operator?"selected":""}>Starts with</option>\n                <option value="ends" ${"ends"===t.operator?"selected":""}>Ends with</option>\n                <option value="isnull" ${"isnull"===t.operator?"selected":""}>IS NULL/Empty</option>\n                <option value="isnotnull" ${"isnotnull"===t.operator?"selected":""}>IS NOT NULL/Empty</option>\n                <option value="gt" ${"gt"===t.operator?"selected":""}>Greater than</option>\n                <option value="lt" ${"lt"===t.operator?"selected":""}>Less than</option>\n                <option value="gte" ${"gte"===t.operator?"selected":""}>≥</option>\n                <option value="lte" ${"lte"===t.operator?"selected":""}>≤</option>\n            </select>\n            <input type="text" placeholder="Filter value" value="${t.value}" onchange="updateFilter(${n}, 'value', this.value)">\n            <button class="btn-danger btn-sm" onclick="removeFilter(${n})" style="padding: 8px 12px;">×</button>\n        `,e.appendChild(a)})}function updateFilter(e,t,n){filters[e]&&(filters[e][t]=n)}function removeFilter(e){filters.splice(e,1),renderFilters(),toggleApplyButton(),applyFilters()}function updateStats(e){document.getElementById("statRows").textContent=parsedData.length,document.getElementById("statColumns").textContent=selectedColumns.length,document.getElementById("statFiltered").textContent=e.length}function formatCellValue(e){return null==e?"":"object"==typeof e?JSON.stringify(e).substring(0,50)+"...":String(e).substring(0,200)}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function initializePGLite(){try{if(!window.PGlite)return showStatus("PGLite library loading... Please wait","info"),void setTimeout(initializePGLite,500);pgliteDB||(pgliteDB=new window.PGlite,await pgliteDB.query("SELECT 1")),await reloadDatabase()}catch(e){console.error("Database Error:",e),showStatus("Database initialization failed: "+e.message,"error")}}async function reloadDatabase(){try{if(!pgliteDB)return void showStatus("Database not initialized","error");showStatus("Populating records for DB query...","info",!0),tableMetadata=[],hierarchicalData&&hierarchicalData.children.length>0?await loadHierarchicalDataIntoPGLite():await loadSimpleDataIntoPGLite()}catch(e){console.error("Database reload error:",e),showStatus("Failed to load data into database: "+e.message,"error")}}async function loadSimpleDataIntoPGLite(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to load into database","error");try{await pgliteDB.query("DROP TABLE IF EXISTS json_data")}catch(e){}const t=`CREATE TABLE json_data (${selectedColumns.map(t=>{const n=e.find(e=>null!==e[t]&&void 0!==e[t]),a=n?n[t]:"";let o="TEXT";return"number"==typeof a?o="NUMERIC":"boolean"==typeof a&&(o="BOOLEAN"),`"${t}" ${o}`}).join(", ")})`;await pgliteDB.query(t);const n=`INSERT INTO json_data (${selectedColumns.map(e=>`"${e}"`).join(", ")}) VALUES (${selectedColumns.map((e,t)=>`$${t+1}`).join(", ")})`;for(const t of e){const e=selectedColumns.map(e=>{const n=t[e];return null==n?null:n});try{await pgliteDB.query(n,e)}catch(e){console.warn("Row insert error:",e)}}tableMetadata=[{name:"json_data",rowCount:e.length}],document.getElementById("querySection").classList.remove("hide"),document.getElementById("pgliteNotReady").classList.add("hide");document.getElementById("sqlQuery").placeholder=`SELECT * FROM json_data LIMIT 10;  -- Use table name: json_data (${e.length} rows)`,showStatus("Database loaded with "+e.length+" rows","success")}async function loadHierarchicalDataIntoPGLite(){const e=[hierarchicalData.parent.tableName];hierarchicalData.children.forEach(t=>e.push(t.tableName));for(const t of e)try{await pgliteDB.query(`DROP TABLE IF EXISTS ${t}`)}catch(e){}await createAndLoadTable(hierarchicalData.parent.tableName,hierarchicalData.parent.data,!1),tableMetadata.push({name:hierarchicalData.parent.tableName,rowCount:hierarchicalData.parent.data.length,type:"parent"});for(const e of hierarchicalData.children)await createAndLoadTable(e.tableName,e.data,!0),tableMetadata.push({name:e.tableName,rowCount:e.data.length,type:"child",parentTable:hierarchicalData.parent.tableName});document.getElementById("querySection").classList.remove("hide"),document.getElementById("pgliteNotReady").classList.add("hide");const t=document.getElementById("sqlQuery"),n=tableMetadata.map(e=>`${e.name} (${e.rowCount} rows)`).join(", ");t.placeholder=`SELECT * FROM ${hierarchicalData.parent.tableName} LIMIT 10;\n-- Available tables: ${n}`,updateAvailableTablesUI();const a=tableMetadata.reduce((e,t)=>e+t.rowCount,0);showStatus(`Database loaded with ${tableMetadata.length} tables, ${a} total rows`,"success")}function updateAvailableTablesUI(){const e=document.getElementById("availableTablesInfo"),t=document.getElementById("tablesList"),n=document.getElementById("joinExamples");if(tableMetadata.length>1){e.style.display="block";let a="";const o=tableMetadata.find(e=>"parent"===e.type),r=tableMetadata.filter(e=>"child"===e.type);if(o&&(a+=`<div>• <strong>${o.name}</strong> (${o.rowCount} rows) - Parent table</div>`),r.forEach(e=>{a+=`<div>• <strong>${e.name}</strong> (${e.rowCount} rows) - Child of ${e.parentTable}</div>`}),t.innerHTML=a,o&&r.length>0){n.style.display="block";const e=r[0];if(document.getElementById("joinExample1").textContent=`SELECT * FROM ${o.name} p JOIN ${e.name} c ON p._id = c._parent_id`,r.length>1){const t=r[1];document.getElementById("joinExample2").textContent=`SELECT p.*, c1.*, c2.* FROM ${o.name} p JOIN ${e.name} c1 ON p._id = c1._parent_id JOIN ${t.name} c2 ON p._id = c2._parent_id`}}}else e.style.display="none",n.style.display="none"}async function createAndLoadTable(e,t,n){if(0===t.length)return;const a=new Set;t.forEach(e=>{Object.keys(e).forEach(e=>a.add(e))});const o=`CREATE TABLE ${e} (${Array.from(a).map(e=>{const n=t.find(t=>null!==t[e]&&void 0!==t[e]),a=n?n[e]:"";let o="TEXT";return"number"==typeof a?o="NUMERIC":"boolean"==typeof a&&(o="BOOLEAN"),`"${e}" ${o}`}).join(", ")})`;await pgliteDB.query(o);const r=Array.from(a),l=`INSERT INTO ${e} (${r.map(e=>`"${e}"`).join(", ")}) VALUES (${r.map((e,t)=>`$${t+1}`).join(", ")})`;for(const e of t){const t=r.map(t=>{const n=e[t];return null==n?null:n});try{await pgliteDB.query(l,t)}catch(e){console.warn("Row insert error:",e)}}}async function executeSQLQuery(){const e=document.getElementById("queryError");e.classList.add("hide"),e.textContent="";try{if(!pgliteDB)return void showQueryError("Database not initialized yet. Please wait and try again.");const e=document.getElementById("sqlQuery").value.trim();if(!e)return void showQueryError("Please enter a SQL query");try{const t=await pgliteDB.query(e),n=t.rows||t||[];displayQueryResult(Array.isArray(n)?n:[]),showStatus("Query executed successfully","success"),setTimeout(()=>{document.getElementById("queryResult").scrollIntoView({behavior:"smooth",block:"start"})},100)}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("Query error: "+e.message)}}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("Query error: "+e.message)}}function switchQueryMode(e){document.querySelectorAll(".query-mode-btn").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-mode")===e)}),"sql"===e?(document.getElementById("sqlSection").classList.remove("hide"),document.getElementById("jsonpathSection").classList.add("hide")):"jsonpath"===e&&(document.getElementById("sqlSection").classList.add("hide"),document.getElementById("jsonpathSection").classList.remove("hide")),document.getElementById("queryError").classList.add("hide"),document.getElementById("queryError").textContent=""}function executeJSONPathQuery(){const e=document.getElementById("queryError");e.classList.add("hide"),e.textContent="";try{if(!jsonData)return void showQueryError("No JSON data loaded. Please parse JSON first.");const e=document.getElementById("jsonpathQuery").value.trim();if(!e)return void showQueryError("Please enter a JSONPath query");if(!window.jsonpath)return showQueryError("JSONPath library not loaded. Please refresh the page."),void console.error("window.jsonpath is not available. Available:",Object.keys(window).filter(e=>e.toLowerCase().includes("json")));try{const t=window.jsonpath.query(jsonData,e);if(t&&0!==t.length){const e=normalizeJSONPathResult(t);displayQueryResult(e),showStatus(`Query executed successfully (${e.length} results)`,"success")}else displayQueryResult([]),showStatus("Query executed successfully (0 results)","success");setTimeout(()=>{document.getElementById("queryResult").scrollIntoView({behavior:"smooth",block:"start"})},100)}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("JSONPath query error: "+e.message)}}catch(e){document.getElementById("queryResult").classList.add("hide"),showQueryError("Query error: "+e.message)}}function normalizeJSONPathResult(e){return Array.isArray(e)&&e.length>0&&"object"==typeof e[0]&&null!==e[0]&&!Array.isArray(e[0])?e:Array.isArray(e)||"object"!=typeof e||null===e?Array.isArray(e)?e.map((e,t)=>"object"!=typeof e||null===e||Array.isArray(e)?{index:t,value:e}:e):[{value:e}]:[e]}function showQueryError(e){const t=document.getElementById("queryError"),n=document.getElementById("queryPanel"),a=document.getElementById("querySection");if(t.textContent=e,t.classList.remove("hide"),n.classList.contains("collapsed")){n.classList.remove("collapsed");const e=document.getElementById("querySectionToggle");e&&(e.textContent="Hide Section")}a&&a.classList.contains("hide")&&a.classList.remove("hide"),setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},100)}function displayQueryResult(e){const t=document.getElementById("resultContent"),n=document.getElementById("queryResult");if(e&&0!==e.length){let n="<table><thead><tr>";const a=Object.keys(e[0]);a.forEach(e=>{n+=`<th>${escapeHtml(String(e))}</th>`}),n+="</tr></thead><tbody>";const o=e.slice(0,1e3);o.forEach(e=>{n+="<tr>",a.forEach(t=>{const a=e[t],o=null==a?"NULL":String(a);n+=`<td>${escapeHtml(o)}</td>`}),n+="</tr>"}),n+="</tbody></table>",e.length>o.length?n+=`<div style="color: var(--text-secondary); padding: 8px; font-size: 11px; margin-top: 8px;">Showing ${o.length} of ${e.length} rows</div>`:n+=`<div style="color: var(--text-secondary); padding: 8px; font-size: 11px; margin-top: 8px;">${e.length} row${1!==e.length?"s":""}</div>`,t.innerHTML=n}else t.innerHTML='<div style="color: var(--text-secondary); padding: 12px; text-align: center;">(0 rows)</div>';n.classList.remove("hide")}function exportToCSV(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to export","error");let t=selectedColumns.map(e=>`"${e.replace(/"/g,'""')}"`).join(",")+"\n";e.forEach(e=>{t+=selectedColumns.map(t=>{const n=e[t];return`"${String(n).replace(/"/g,'""')}"`}).join(",")+"\n"}),downloadFile(t,"data.csv","text/csv")}function exportToJSON(){const e=getFilteredData();if(0===e.length)return void showStatus("No data to export","error");downloadFile(JSON.stringify(e,null,2),"data.json","application/json")}function downloadFile(e,t,n){const a=new Blob([e],{type:n}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),showStatus(`Exported as ${t}`,"success")}function clearInput(){document.getElementById("jsonInput").value="",document.getElementById("fileInput").value="",jsonData=null,parsedData=[],selectedColumns=[],allColumns=[],filters=[],document.getElementById("tableContainer").classList.add("hide"),document.getElementById("noData").classList.add("hide"),document.getElementById("columnSelector").classList.add("hide"),document.getElementById("filterControls").classList.add("hide"),document.getElementById("querySection").classList.add("hide"),document.getElementById("detailsEmpty").classList.remove("hide"),document.getElementById("detailsStatusMessage").classList.remove("show"),renderFilters(),toggleApplyButton(),document.getElementById("statRows").textContent="0",document.getElementById("statColumns").textContent="0",document.getElementById("statFiltered").textContent="0",document.getElementById("statsContainer").style.display="none"}function showLoader(){document.getElementById("loadingOverlay").style.display="block"}function hideLoader(){document.getElementById("loadingOverlay").style.display="none"}function openHelpModal(e){e&&(e.preventDefault(),e.stopPropagation()),document.getElementById("helpModal").style.display="block",document.body.style.overflow="hidden"}function closeHelpModal(){document.getElementById("helpModal").style.display="none",document.body.style.overflow="auto"}function openFAQModal(e){e&&(e.preventDefault(),e.stopPropagation()),document.getElementById("faqModal").style.display="block",document.body.style.overflow="hidden"}function closeFAQModal(){document.getElementById("faqModal").style.display="none",document.body.style.overflow="auto"}function detectComplexStructure(e,t=0,n=0){return analyzeStructure(e).hasMultipleNestedArrays}function changeDisplayMode(){const e=document.querySelector('input[name="displayMode"]:checked').value;displayMode=e,jsonData&&(normalizeData(),detectStructure(),buildColumns(),buildTable(),pgliteDB&&parsedData.length>0&&loadDataIntoPGLite())}window.addEventListener("click",function(e){const t=document.getElementById("helpModal"),n=document.getElementById("faqModal");e.target===t?closeHelpModal():e.target===n&&closeFAQModal()}),document.addEventListener("keydown",function(e){"Escape"===e.key&&(closeHelpModal(),closeFAQModal())});